<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Location Autocomplete</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .location-suggestions{position:absolute;width:100%;max-height:250px;overflow-y:auto;background:#fff;border:1px solid #ddd;border-radius:.25rem;z-index:1000;box-shadow:0 5px 10px rgba(0,0,0,.2);display:none;top:100%;left:0}
    .location-suggestion-item{padding:10px 15px;border-bottom:1px solid #eee;cursor:pointer}
    .location-suggestion-item:hover{background-color:#f8f9fa}
    .location-name{font-weight:500}.location-address{font-size:.85rem;color:#6c757d}
    .spinner-container{position:absolute;right:15px;top:50%;transform:translateY(-50%);z-index:10;display:none}
    .spinner-container.active{display:block}.input-group-with-suggestions{position:relative}
    .location-no-results{padding:10px 15px;text-align:center;color:#6c757d}
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-4">Location Autocomplete Test</h1>
    <div class="alert alert-info"><i class="fas fa-info-circle me-2"></i> Type in the fields below to search for locations in Malaysia.</div>
    
    <div class="row">
      <div class="col-md-6 mb-4">
        <label for="pickup" class="form-label fw-bold">Pickup Location</label>
        <div class="input-group input-group-lg input-group-with-suggestions">
          <span class="input-group-text bg-light border-end-0"><i class="fas fa-map-marker-alt text-primary"></i></span>
          <input type="text" class="form-control border-start-0" id="pickup" name="pickup" placeholder="Search pickup location in Malaysia" required autocomplete="off">
          <div class="spinner-container" id="pickup-spinner"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></div>
          <input type="hidden" id="pickup_lat" name="pickup_lat">
          <input type="hidden" id="pickup_lon" name="pickup_lon">
          <div class="location-suggestions" id="pickup-suggestions"></div>
        </div>
        <div class="invalid-feedback-custom text-danger mt-1 d-none" id="pickup-error"></div>
      </div>
      
      <div class="col-md-6 mb-4">
        <label for="destination" class="form-label fw-bold">Destination</label>
        <div class="input-group input-group-lg input-group-with-suggestions">
          <span class="input-group-text bg-light border-end-0"><i class="fas fa-location-arrow text-primary"></i></span>
          <input type="text" class="form-control border-start-0" id="destination" name="destination" placeholder="Search destination in Malaysia" required autocomplete="off">
          <div class="spinner-container" id="destination-spinner"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></div>
          <input type="hidden" id="destination_lat" name="destination_lat">
          <input type="hidden" id="destination_lon" name="destination_lon">
          <div class="location-suggestions" id="destination-suggestions"></div>
        </div>
        <div class="invalid-feedback-custom text-danger mt-1 d-none" id="destination-error"></div>
      </div>
    </div>

    <!-- Debug Section -->
    <div class="card mt-4">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">Debug Information</h5>
      </div>
      <div class="card-body">
        <div id="debug-output" class="small">
          <div class="text-muted">Search status will appear here...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Fallback locations and search cache
    const fallbackLocations = [
      {display_name:"Universiti Teknikal Malaysia Melaka (UTeM) Main Campus, Jalan UTEM, Hang Tuah Jaya Municipal Council, Alor Gajah, Malacca, 76100, Malaysia",lat:"2.3139",lon:"102.3197"},
      {display_name:"Kuala Lumpur International Airport (KLIA), Sepang, Selangor, Malaysia",lat:"2.7456",lon:"101.7099"},
      {display_name:"Kuala Lumpur City Centre, Kuala Lumpur, Federal Territory of Kuala Lumpur, Malaysia",lat:"3.1502",lon:"101.7077"},
      {display_name:"Melaka Sentral, Jalan Tun Razak, Peringgit, Malacca City, Malacca, Malaysia",lat:"2.2343",lon:"102.2465"},
      {display_name:"Dataran Pahlawan Melaka Megamall, Jalan Merdeka, Banda Hilir, Malacca City, Malacca, Malaysia",lat:"2.1905",lon:"102.2501"}
    ], searchCache = {};
    
    document.addEventListener('DOMContentLoaded', () => {
      // DOM elements
      const els = {
        pickup: {
          input: document.getElementById('pickup'),
          lat: document.getElementById('pickup_lat'),
          lon: document.getElementById('pickup_lon'),
          suggestions: document.getElementById('pickup-suggestions'),
          error: document.getElementById('pickup-error'),
          spinner: document.getElementById('pickup-spinner')
        },
        destination: {
          input: document.getElementById('destination'),
          lat: document.getElementById('destination_lat'),
          lon: document.getElementById('destination_lon'),
          suggestions: document.getElementById('destination-suggestions'),
          error: document.getElementById('destination-error'),
          spinner: document.getElementById('destination-spinner')
        }
      };
      
      // Setup both inputs
      ['pickup', 'destination'].forEach(type => {
        const el = els[type];
        
        // Input event
        el.input.addEventListener('input', () => {
          const query = el.input.value.trim();
          query.length > 0 ? search(query, el) : (el.suggestions.style.display = 'none');
        });
        
        // Focus event
        el.input.addEventListener('focus', () => {
          const query = el.input.value.trim();
          if (query.length > 0) search(query, el);
        });
      });
      
      // Search function
      async function search(query, el) {
        if (!query.trim()) return;
        
        // Show spinner
        el.spinner.classList.add('active');
        
        // Add Malaysia to query if not included
        if (!query.toLowerCase().includes('malaysia')) query += ' Malaysia';
        
        // Check cache first
        if (searchCache[query]) {
          displayResults(searchCache[query], query, el);
          el.spinner.classList.remove('active');
          return;
        }
        
        try {
          // Fetch from API with timeout
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 3000);
          
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1&_=${Date.now()}`, {
            headers: {'User-Agent': 'MyTaxiApp/1.0', 'Accept-Language': 'en'},
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          if (!response.ok) throw new Error();
          
          const data = await response.json();
          searchCache[query] = data;
          
          // If no results, try fallback data
          if (data.length === 0) {
            const filtered = fallbackLocations.filter(loc => 
              loc.display_name.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filtered.length > 0) {
              searchCache[query] = filtered;
              displayResults(filtered, query, el);
            } else {
              displayResults([], query, el);
            }
          } else {
            displayResults(data, query, el);
          }
        } catch (err) {
          // Use fallback on error
          const filtered = fallbackLocations.filter(loc => 
            loc.display_name.toLowerCase().includes(query.toLowerCase())
          );
          
          if (filtered.length > 0) {
            searchCache[query] = filtered;
            displayResults(filtered, query, el);
          } else {
            displayResults([], query, el);
          }
        } finally {
          el.spinner.classList.remove('active');
        }
      }
      
      // Display results function
      function displayResults(data, query, el) {
        if (data.length === 0) {
          el.suggestions.innerHTML = `<div class="location-no-results">No locations found for "${query}"</div>`;
          el.suggestions.style.display = 'block';
          if (el.error) {
            el.error.textContent = `No locations found for "${query}"`;
            el.error.classList.remove('d-none');
          }
        } else {
          if (el.error) el.error.classList.add('d-none');
          
          el.suggestions.innerHTML = data.map(location => {
            const name = location.display_name;
            const mainName = name.split(',')[0];
            const address = name.split(',').slice(1, 3).join(',').trim();
            
            return `<div class="location-suggestion-item" data-lat="${location.lat}" data-lon="${location.lon}" data-name="${name}">
              <div class="location-name">${mainName}</div>
              <div class="location-address">${address}</div>
            </div>`;
          }).join('');
          
          el.suggestions.style.display = 'block';
          
          // Add click event listeners
          el.suggestions.querySelectorAll('.location-suggestion-item').forEach(item => {
            item.addEventListener('click', function() {
              const lat = this.dataset.lat;
              const lon = this.dataset.lon;
              const name = this.dataset.name;
              
              el.input.value = name.split(',')[0];
              el.lat.value = lat;
              el.lon.value = lon;
              if (el.error) el.error.classList.add('d-none');
              el.suggestions.style.display = 'none';
            });
          });
        }
      }
      
      // Initial test search
      setTimeout(() => search('Kuala Lumpur', els.pickup), 500);
    });
  </script>
</body>
</html> 