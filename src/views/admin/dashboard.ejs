<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | MyTaxi</title>
  <!-- Modern UI Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .border-left-primary {
      border-left: 0.25rem solid var(--primary) !important;
    }
    .border-left-success {
      border-left: 0.25rem solid var(--success) !important;
    }
    .border-left-info {
      border-left: 0.25rem solid var(--info) !important;
    }
    .border-left-warning {
      border-left: 0.25rem solid var(--warning) !important;
    }
    .avatar {
      width: 36px;
      height: 36px;
      overflow: hidden;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .admin-header {
      background-color: #343a40;
      color: white;
      padding: 1rem 0;
      margin-bottom: 2rem;
    }
    .admin-logo {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .admin-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .admin-user {
      display: flex;
      align-items: center;
    }
    .admin-user .avatar {
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }
    .admin-content {
      padding: 20px 0;
    }
  </style>
</head>
<body>
  <!-- Admin Header -->
  <header class="admin-header">
    <div class="container">
      <div class="admin-nav">
        <div class="admin-logo">
          <i class="fas fa-taxi me-2"></i>
          <span>MyTaxi Admin</span>
        </div>
        <div class="admin-user">
          <div class="avatar">
            <img src="<%= user.profilePicture || '/images/default-profile.png' %>" alt="<%= user.name %>" class="rounded-circle">
          </div>
          <div class="dropdown">
            <button class="btn btn-dark dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <%= user.name %>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="/"><i class="fas fa-home me-2"></i>Home</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/auth/logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Admin Dashboard -->
  <div class="admin-content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card mb-4">
            <div class="card-header pb-0 d-flex justify-content-between align-items-center">
              <h6>Admin Dashboard</h6>
              <div>
                <a href="/admin/reports" class="btn btn-sm btn-primary">
                  <i class="fas fa-chart-bar me-1"></i> View Reports
                </a>
              </div>
            </div>
            <div class="card-body px-0 pt-0 pb-2">
              <div class="table-responsive p-0">
                <div class="p-4">
                  <h2>Welcome, <%= user.name %></h2>
                  <p>You are logged in as an administrator. This is your dashboard.</p>
                  
                  <!-- System Stats -->
                  <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-4">
                      <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                          <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Users</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= stats.totalUsers %></div>
                            </div>
                            <div class="col-auto">
                              <i class="fas fa-users fa-2x text-gray-300"></i>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                      <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                          <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Drivers</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= stats.totalDrivers %></div>
                            </div>
                            <div class="col-auto">
                              <i class="fas fa-car fa-2x text-gray-300"></i>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                      <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                          <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                              <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Passengers</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= stats.totalPassengers %></div>
                            </div>
                            <div class="col-auto">
                              <i class="fas fa-user fa-2x text-gray-300"></i>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                      <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                          <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Total Rides</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= stats.totalRides %></div>
                            </div>
                            <div class="col-auto">
                              <i class="fas fa-taxi fa-2x text-gray-300"></i>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="row mb-4">
                    <div class="col-xl-4 col-md-6 mb-4">
                      <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                          <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Completed Rides</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= stats.completedRides %></div>
                            </div>
                            <div class="col-auto">
                              <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-xl-4 col-md-6 mb-4">
                      <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                          <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pending Rides</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= stats.pendingRides %></div>
                            </div>
                            <div class="col-auto">
                              <i class="fas fa-clock fa-2x text-gray-300"></i>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-xl-4 col-md-6 mb-4">
                      <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                          <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Revenue</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= stats.totalRevenue %></div>
                            </div>
                            <div class="col-auto">
                              <i class="fas fa-money-bill-wave fa-2x text-gray-300"></i>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- User Management -->
                  <div class="card mb-4">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">User Management</h5>
                        <button class="btn btn-sm btn-primary" id="refreshUserList">
                          <i class="fas fa-sync-alt me-1"></i> Refresh
                        </button>
                      </div>
                      <div class="table-responsive">
                        <table class="table align-items-center mb-0" id="usersTable">
                          <thead>
                            <tr>
                              <th>User</th>
                              <th>Contact</th>
                              <th>Details</th>
                              <th>Role</th>
                              <th>Joined</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody id="userTableBody">
                            <tr>
                              <td colspan="6" class="text-center">Loading users...</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Details Modal -->
  <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userDetailsModalLabel">User Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="userDetailsContent">
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading user details...</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete User Confirmation Modal -->
  <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteUserModalLabel">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this user? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete User</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Role Modal -->
  <div class="modal fade" id="editUserRoleModal" tabindex="-1" aria-labelledby="editUserRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editUserRoleModalLabel">Change User Role</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editRoleForm">
            <div class="mb-3">
              <label for="userRole" class="form-label">Select Role</label>
              <select class="form-select" id="userRole" required>
                <option value="passenger">Passenger</option>
                <option value="driver">Driver</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveRoleBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modern JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      loadUsers();
      
      // Refresh user list button
      document.getElementById('refreshUserList').addEventListener('click', loadUsers);
      
      // Delete user functionality
      let userToDelete = null;
      let userToDeleteRole = null;
      
      document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (userToDelete) {
          deleteUser(userToDelete, userToDeleteRole);
        }
      });
      
      // Edit user role functionality
      let userToEdit = null;
      let currentRole = null;
      
      document.getElementById('saveRoleBtn').addEventListener('click', function() {
        if (userToEdit) {
          const newRole = document.getElementById('userRole').value;
          if (newRole !== currentRole) {
            updateUserRole(userToEdit, newRole);
          } else {
            $('#editUserRoleModal').modal('hide');
          }
        }
      });
    });
    
    function loadUsers() {
      fetch('/admin/api/users')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(users => {
          console.log('Users loaded:', users);
          renderUserTable(users);
        })
        .catch(error => {
          console.error('Error loading users:', error);
          document.getElementById('userTableBody').innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-danger">Failed to load users. Please try again.</td>
            </tr>
          `;
        });
    }
    
    function renderUserTable(users) {
      const tbody = document.getElementById('userTableBody');
      
      console.log('Rendering user table with users:', users);
      
      if (!users || users.length === 0 || (users.success === false)) {
        console.log('No users found or error in response');
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center">No users found</td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = users.map(user => `
        <tr data-id="${user._id || user.id}" data-role="${user.role.toLowerCase()}">
          <td>
            <div class="d-flex px-3 py-1">
              <div class="avatar avatar-sm me-3">
                <img src="${user.profilePicture || '/images/default-profile.png'}" alt="${user.name}" class="rounded-circle">
              </div>
              <div class="d-flex flex-column justify-content-center">
                <h6 class="mb-0 text-sm">${user.name}</h6>
                <p class="text-xs text-secondary mb-0">${user.email}</p>
              </div>
            </div>
          </td>
          <td>
            <p class="text-xs font-weight-bold mb-0">${user.phone || 'N/A'}</p>
          </td>
          <td>
            ${user.role.toLowerCase() === 'driver' ? `
              <p class="text-xs mb-0">Car: ${user.carModel || 'N/A'}</p>
              <p class="text-xs mb-0">Plate: ${user.carPlateNumber || 'N/A'}</p>
              <p class="text-xs mb-0">License: ${user.license_number || 'N/A'}</p>
            ` : ''}
            <p class="text-xs mb-0">Student ID: ${user.studentId || 'N/A'}</p>
            <p class="text-xs mb-0">Faculty: ${user.faculty || 'N/A'}</p>
          </td>
          <td>
            <span class="badge bg-${user.role.toLowerCase() === 'driver' ? 'info' : 'primary'}">
              ${user.role}
            </span>
            ${user.role.toLowerCase() === 'driver' ? `
              <span class="badge bg-${user.status === 'available' ? 'success' : (user.status === 'busy' ? 'warning' : 'secondary')}">
                ${user.status || 'N/A'}
              </span>
            ` : ''}
          </td>
          <td>
            <span class="text-secondary text-xs font-weight-bold">${user.joined}</span>
          </td>
          <td class="align-middle">
            <button class="btn btn-sm btn-info view-user-btn" data-id="${user._id || user.id}" data-role="${user.role.toLowerCase()}">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-warning edit-role-btn" data-id="${user._id || user.id}" data-role="${user.role.toLowerCase()}">
              <i class="fas fa-user-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger delete-user-btn" data-id="${user._id || user.id}" data-role="${user.role.toLowerCase()}">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
      
      // Add event listeners to new buttons
      document.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          userToDelete = this.getAttribute('data-id');
          userToDeleteRole = this.getAttribute('data-role');
          $('#deleteUserModal').modal('show');
        });
      });
      
      document.querySelectorAll('.edit-role-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          userToEdit = this.getAttribute('data-id');
          currentRole = this.getAttribute('data-role');
          document.getElementById('userRole').value = currentRole;
          $('#editUserRoleModal').modal('show');
        });
      });
      
      document.querySelectorAll('.view-user-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const userId = this.getAttribute('data-id');
          const userRole = this.getAttribute('data-role');
          showUserDetails(userId, userRole);
        });
      });
      
      // Initialize DataTable if available
      if ($.fn.DataTable) {
        if ($.fn.DataTable.isDataTable('#usersTable')) {
          $('#usersTable').DataTable().destroy();
        }
        $('#usersTable').DataTable({
          responsive: true,
          order: [[4, 'desc']], // Sort by joined date by default
          language: {
            search: "_INPUT_",
            searchPlaceholder: "Search users..."
          }
        });
      }
    }
    
    function showUserDetails(userId, role) {
      console.log('Showing details for user:', userId, 'with role:', role);
      const detailsContent = document.getElementById('userDetailsContent');
      detailsContent.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p>Loading user details...</p>
        </div>
      `;
      
      $('#userDetailsModal').modal('show');
      
      // Fetch user details from API
      fetch(`/admin/api/users/${userId}?role=${role}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(user => {
          console.log('User details loaded:', user);
          if (user) {
            // Format joined date
            const joinedDate = user.joined_at ? new Date(user.joined_at).toLocaleDateString() : 'N/A';
            
            // Build user details HTML
            let detailsHtml = `
              <div class="row">
                <div class="col-md-4 text-center mb-4">
                  <img src="${user.profilePicture || '/images/default-profile.png'}" alt="${user.name}" class="rounded-circle img-fluid mb-3" style="max-width: 150px;">
                  <h5>${user.name}</h5>
                  <span class="badge bg-${role === 'driver' ? 'info' : 'primary'} mb-2">${role.charAt(0).toUpperCase() + role.slice(1)}</span>
                </div>
                <div class="col-md-8">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <h6 class="text-muted">Contact Information</h6>
                      <p><strong>Email:</strong> ${user.email}</p>
                      <p><strong>Phone:</strong> ${user.phone || 'Not provided'}</p>
                    </div>
                    <div class="col-md-6">
                      <h6 class="text-muted">Account Information</h6>
                      <p><strong>Student ID:</strong> ${user.studentId || 'Not provided'}</p>
                      <p><strong>Faculty:</strong> ${user.faculty || 'Not provided'}</p>
                      <p><strong>Joined:</strong> ${joinedDate}</p>
                    </div>
                  </div>
            `;
            
            // Add driver-specific information
            if (role === 'driver') {
              detailsHtml += `
                <div class="row mb-3">
                  <div class="col-12">
                    <h6 class="text-muted">Driver Information</h6>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Car Model:</strong> ${user.carModel || 'Not provided'}</p>
                    <p><strong>License Plate:</strong> ${user.carPlateNumber || 'Not provided'}</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>License Number:</strong> ${user.license_number || 'Not provided'}</p>
                    <p><strong>Status:</strong> <span class="badge bg-${user.status === 'available' ? 'success' : (user.status === 'busy' ? 'warning' : 'secondary')}">${user.status || 'Unknown'}</span></p>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                    <h6 class="text-muted">Ratings</h6>
                    <p><strong>Average Rating:</strong> ${user.average_rating ? user.average_rating.toFixed(1) + ' / 5.0' : 'No ratings yet'}</p>
                    <p><strong>Total Ratings:</strong> ${user.rating_count || 0}</p>
                  </div>
                </div>
              `;
            }
            
            // Close the row and column divs
            detailsHtml += `
                </div>
              </div>
            `;
            
            detailsContent.innerHTML = detailsHtml;
          } else {
            detailsContent.innerHTML = `<p class="text-center text-danger">Failed to load user details.</p>`;
          }
        })
        .catch(error => {
          console.error('Error fetching user details:', error);
          detailsContent.innerHTML = `<p class="text-center text-danger">An error occurred while loading user details.</p>`;
        });
    }
    
    function deleteUser(userId, role) {
      console.log('Deleting user:', userId, 'with role:', role);
      fetch(`/admin/users/${userId}?role=${role}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Delete response:', data);
        if (data.success) {
          // Remove the row from the table
          const row = document.querySelector(`tr[data-id="${userId}"]`);
          if (row) row.remove();
          
          // Hide the modal
          $('#deleteUserModal').modal('hide');
          
          // Show success message
          alert('User deleted successfully');
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error deleting user:', error);
        alert('An error occurred while deleting the user');
      });
    }
    
    function updateUserRole(userId, newRole) {
      console.log('Updating user role:', userId, 'to:', newRole);
      fetch(`/admin/users/${userId}/update-role`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ newRole })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Update role response:', data);
        if (data.success) {
          // Hide the modal
          $('#editUserRoleModal').modal('hide');
          
          // Refresh the user list
          loadUsers();
          
          // Show success message
          alert('User role updated successfully');
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error updating user role:', error);
        alert('An error occurred while updating the user role');
      });
    }
  </script>
</body>
</html> 